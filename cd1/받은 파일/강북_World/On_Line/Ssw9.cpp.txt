#include "struct.h"
#define n 4
#define m 3

int a[n][m],b[n][m],c[9][2],d[9],minc,minSL,dn,an,da[5000][3],ans[5000][3],SL,car[9],maxc,shortest;
long far *t1=(long far*)0x46cL,t2;

void dfs(int x,int y,int dis)
{
	if(b[x][y]==-1 && shortest>dis)
	{
		shortest=dis;
		return;
	}
	if(b[x][y]==0)b[x][y]=-2;
	if(x>0 && (b[x-1][y]==0 || b[x-1][y]==-1))dfs(x-1,y,dis+1);
	if(x<n-1 && (b[x+1][y]==0 || b[x+1][y]==-1))dfs(x+1,y,dis+1);
	if(y>0 && (b[x][y-1]==0 || b[x][y-1]==-1))dfs(x,y-1,dis+1);
	if(y<m-1 && (b[x][y+1]==0 || b[x][y+1]==-1))dfs(x,y+1,dis+1);
	if(b[x][y]==-2)b[x][y]=0;
}

int main()
{
	int k,i,j;
	char cc;
	FILE *in;
	t2=*t1;
	maxc=0;
	in=fopen("input.dat","rt");
	fscanf(in,"%d ",&k);
	for(i=0;i<k;i++)
	{
		fscanf(in,"%d ",&d[i]);
	}
	for(i=0;i<n;i++)
	{
		for(j=0;j<m;j++)
		{
			fscanf(in,"%c",&cc);
			if(cc=='E')a[i][j]=-1; else
			{
				a[i][j]=cc-'0';
				if(a[i][j]>maxc)maxc=a[i][j];
				c[a[i][j]][0]=i;
				c[a[i][j]][1]=j;
			}
			fscanf(in,"%c",&cc);
		}
	}
	fclose(in);
	an=0;
	int t=0;
	minc=32767;
	randomize();
	while((*t1-t2)/18.206<4.8)
	{
		dn=0;
		t=0;
		for(i=0;i<n;i++)
			for(j=0;j<m;j++)
			{
				b[i][j]=a[i][j];
				if(b[i][j]>0)
				{
					c[b[i][j]][0]=i;
					c[b[i][j]][1]=j;
				}
			}
		for(i=0;i<9;i++)car[i]=0;
		SL=0;
		while(t<=k)
		{
			while(1)
			{
				shortest=32767;
				dfs(c[d[t]][0],c[d[t]][1],0);
				if(shortest==32767)break;
				car[d[t]]=1;
				b[c[d[t]][0]][c[d[t]][1]]=0;
				c[d[t]][0]=-1;
				t++;
				SL+=shortest;
				da[dn][0]=d[t-1];
				da[dn++][1]=-1;
				if(t>=k)break;
			}
			if(t>=k)break;
			int r;
			while(1)
			{
				r=random(maxc)+1;
				if(c[r][0]==-1)continue;
				if((b[c[r][0]-1][c[r][1]]!=0 || c[r][0]==0) &&
				(b[c[r][0]+1][c[r][1]]!=0 || c[r][0]==n-1) &&
				(b[c[r][0]][c[r][1]-1]!=0 || c[r][1]==0) &&
				(b[c[r][0]][c[r][1]+1]!=0 || c[r][1]==m-1)) continue;
				int dx,dy;
				while(1)
				{
					dx=random(3)-1;
					dy=random(3)-1;
					if((dx==0 ^ dy==0) && b[c[r][0]+dx][c[r][1]+dy]==0 && c[r][0]+dx<n && c[r][0]+dx>=0 && c[r][1]+dy<m && c[r][1]+dy>=0) break;
				}
				SL+=1;
				b[c[r][0]+dx][c[r][1]+dy]=r;
				b[c[r][0]][c[r][1]]=0;
				c[r][0]+=dx;
				c[r][1]+=dy;
				car[r]=1;
				da[dn][0]=r;
				da[dn][1]=c[r][0];
				da[dn++][2]=c[r][1];
				break;
			}
		}
		int tl=0;
		for(i=1;i<=8;i++)if(car[i]==1)tl++;
		if(tl<minc || (minc==tl && minSL>SL))
		{
			minc=tl;
			minSL=SL;
			an=dn;
			for(i=0;i<an;i++)ans[i][0]=da[i][0],ans[i][1]=da[i][1],ans[i][2]=da[i][2];
		}
	}
	FILE *out;
	out=fopen("output.dat","wt");
	for(i=0;i<an;i++)
	{
		fprintf(out,"%d. C%d ",i+1,ans[i][0]);
		if(ans[i][1]==-1)fprintf(out,"Exit"); else fprintf(out,"(%d,%d)",ans[i][1]+1,ans[i][2]+1);
		fprintf(out,"\n");
	}
	fprintf(out,"car=%d\n",minc);
	fprintf(out,"SL = %d\n",minSL);
	fclose(out);
	return 0;
}